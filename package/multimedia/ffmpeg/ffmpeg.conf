# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: package/*/ffmpeg/ffmpeg.conf
# Copyright (C) 2004 - 2024 The T2 SDE Project
# Copyright (C) 1998 - 2003 ROCK Linux Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2.
# --- T2-COPYRIGHT-NOTE-END ---

hook_add preconf 5 'export TMPDIR="$(mktemp -d -p $PWD)"'

var_append confopt ' ' '--disable-doc'

# use our (cross) toolchain for configure, too :-/
var_append conftopt " " "--cc=$CC --cxx=$CXX --ranlib=$RANLIB --host-cc=$CC"
var_append conftopt " " "--disable-stripping"

atstage cross && var_append conftopt " " "--enable-cross-compile"

# select architecture, for cross compilation
var_append conftopt " " "--arch=`echo $arch | arch2uname`"

# .so file location
var_append conftopt " " "--shlibdir=$libdir"

# debug
[ "$SDECFG_DEBUG" = 1 ] && var_append confopt ' ' --disable-debug \
	|| var_append confopt ' ' --disable-debug

pkginstalled valgrind || var_append conftopt ' ' --disable-valgrind-backtrace

# use (L)GPL version 3
var_append conftopt ' ' --enable-version3

# shared libraries
var_append confopt ' ' --enable-shared

# fill options the configure does not attempt to detect ...
var_append confopt ' ' --enable-pthreads

# disks support
pkginstalled xvid && var_append conftopt ' ' --enable-libxvid
pkginstalled libbluray && var_append conftopt ' ' --enable-libbluray
pkginstalled libcdio-paranoia && var_append conftopt ' ' --enable-libcdio

# codec: av1
pkginstalled dav1d && var_append conftopt ' ' --enable-dav1d
pkginstalled rav1e && var_append conftopt ' ' --enable-rav1e
pkginstalled libaom && var_append conftopt ' ' --enable-libaom
pkginstalled svt-av1 && var_append conftopt ' ' --enable-libsvtav1

# various codecs
pkginstalled x264 && var_append conftopt ' ' --enable-libx264
pkginstalled x265 && var_append conftopt ' ' --enable-libx265
pkginstalled libvpx && var_append conftopt ' ' --enable-libvpx
pkginstalled libtheora && var_append conftopt ' ' --enable-libtheora

# hardware acceleration
var_append confopt ' ' --disable-vulkan
pkginstalled onevpl && var_append conftopt ' ' --enable-libvpl

# window system
if ! pkginstalled libsdl2; then
	var_append conftopt ' ' --disable-sdl2
	var_append conftopt ' ' --disable-ffplay
fi

# font support
pkginstalled harfbuzz && var_append confopt ' ' --enable-libharfbuzz
pkginstalled freetype && var_append conftopt ' ' --enable-libfreetype

# compression
pkginstalled zlib && var_append conftopt ' ' --enable-zlib
pkginstalled libsnappy && var_append conftopt ' ' --enable-libsnappy

# network
# openssl, gnutls and mbedtls are mutually excluding
pkginstalled openssl && var_append confopt ' ' --enable-openssl
#pkginstalled gnutls && var_append confopt ' ' --enable-gnutls
#pkginstalled mbedtls && var_append confopt ' ' --enable-mbedtls

pkginstalled opencore-amr &&
	var_append conftopt " " "--enable-libopencore-amrnb --enable-libopencore-amrwb"

pkginstalled libdc1394 && pkginstalled libraw1394 && var_append conftopt ' ' --enable-libdc1394
pkginstalled schroedinger && var_append conftopt ' ' --enable-libschroedinger

# audio support
pkginstalled lame && var_append conftopt ' ' --enable-libmp3lame
pkginstalled speex && var_append conftopt ' ' --enable-libspeex
pkginstalled pulseaudio && var_append conftopt ' ' --enable-libpulse

# Imlib2 support
if pkginstalled imlib2; then
	pkgprefix -t imlib2
	var_append conftopt " " "--extra-cflags=-I$root/$(pkgprefix includedir imlib2)"
	var_append conftopt " " "--extra-ldflags=-L$root/$(pkgprefix libdir imlib2)"
fi

# Ogg Vorbis support
if pkginstalled libogg; then
	var_append conftopt " " "--enable-libogg"
	pkginstalled libvorbis && var_append conftopt " " "--enable-libvorbis"
fi

# no fPIC for x86 right now
if [ "$arch" = "x86" ]; then
	var_remove GCC_WRAPPER_APPEND ' ' '-fPIC'

	# configure fails on lame (linker does not use libm with --as-needed)
	var_append GCC_WRAPPER_REMOVE ' ' '-Wl,--as-needed'
fi

var_append makeopt ' ' 'LD=$CC'
var_remove_regex makeopt ' ' 'STRIP=.*'
var_remove_regex makeopt ' ' 'AS=.*'
